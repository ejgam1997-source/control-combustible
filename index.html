<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Combustible</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #27ae60;
            --warning-color: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        /* --- INICIO: Estilos de Login --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #login-box {
            background-color: white;
            padding: 2.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        #login-box h2 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        #login-alert {
            display: none;
            margin-bottom: 1rem;
        }

        .login-toggle {
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .login-toggle a {
            color: var(--secondary-color);
            cursor: pointer;
            text-decoration: none;
        }
        .login-toggle a:hover {
            text-decoration: underline;
        }
        /* --- FIN: Estilos de Login --- */

        #main-app {
            display: none; /* Oculto hasta que se inicie sesión */
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .header-info {
            display: flex;
            align-items: center;
        }

        #user-info {
            margin-right: 1rem;
            font-size: 0.9rem;
        }

        #logout-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        #logout-btn:hover {
            background-color: #c0392b;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav li {
            margin-right: 1rem;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav a:hover, nav a.active {
            background-color: var(--secondary-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .section {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .section.active {
            display: block;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-color);
        }

        h3 {
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        input, select, button {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        input[type="file"] {
            padding: 0.5rem;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: var(--primary-color);
        }
        
        button.danger {
            background-color: var(--accent-color);
        }
        
        button.success {
            background-color: var(--success-color);
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 0.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-badge.draft {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-badge.completed {
            background-color: var(--success-color);
            color: white;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .card h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .card .label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .card.positive .value {
            color: var(--success-color);
        }
        
        .card.negative .value {
            color: var(--accent-color);
        }
        
        .export-options {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .export-options button {
            width: auto;
            padding: 0.75rem 1.5rem;
        }
        
        .tercero-selector {
            margin-bottom: 1.5rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .loading-spinner {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }

        .import-note {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 0.75rem;
            border-radius: 4px;
        }

        .tab-nav {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--light-color);
            margin-bottom: 1.5rem;
        }

        .tab-nav-button {
            padding: 0.75rem 1rem;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-nav-button:hover {
            background-color: var(--light-color);
            color: var(--primary-color);
        }

        .tab-nav-button.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .tab-content {
            display: none;
            border: 1px solid #eee;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            nav ul {
                flex-direction: column;
            }
            
            nav li {
                margin-right: 0;
                margin-bottom: 0.5rem;
            }

            .tab-nav {
                flex-direction: column;
            }
            .tab-nav-button {
                width: 100%;
                text-align: left;
                margin-bottom: 0.5rem;
                border-bottom: 1px solid #eee;
            }
            .tab-nav-button.active {
                border-bottom-color: var(--secondary-color);
            }

            header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-info {
                width: 100%;
                justify-content: space-between;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <h2 id="login-title">Iniciar Sesión</h2>
            <div id="login-alert" class="alert error"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username" style="text-align: left;">Email</label>
                    <input type="email" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password" style="text-align: left;">Contraseña</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" id="login-btn">Ingresar</button>
            </form>
            <div class="login-toggle">
                <span id="login-text">¿No tienes cuenta? <a id="show-register-btn">Regístrate</a></span>
                <span id="register-text" style="display: none;">¿Ya tienes cuenta? <a id="show-login-btn">Inicia Sesión</a></span>
            </div>
        </div>
    </div>
    <div id="main-app">
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading-spinner">
                <h3>Generando PDF...</h3>
                <p>Por favor espere un momento</p>
            </div>
        </div>

        <header>
            <div>
                <h1>Control de Combustible</h1>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active" data-target="terceros">Terceros</a></li>
                        <li><a href="#" class="nav-link" data-target="consumos">Consumos y Facturas</a></li>
                        <li><a href="#" class="nav-link" data-target="anticipos">Anticipos</a></li>
                        <li><a href="#" class="nav-link" data-target="estado-cuenta">Estado de Cuenta</a></li>
                        <li class="requires-admin" style="display: none;"><a href="#" class="nav-link" data-target="admin">Admin</a></li>
                    </ul>
                </nav>
            </div>
            <div class="header-info">
                <span id="user-info"></span>
                <button id="logout-btn">Cerrar Sesión</button>
            </div>
        </header>
        
        <div class="container">
            <section id="terceros" class="section active">
                <h2>Gestión de Terceros</h2>
                <div id="terceros-alert" class="alert" style="display: none;"></div>
                
                <form id="tercero-form" class="requires-editor" style="display: none;">
                    <div class="form-group">
                        <label for="nit">NIT</label>
                        <input type="text" id="nit" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="razon-social">Razón Social</label>
                        <input type="text" id="razon-social" required>
                    </div>
                    
                    <button type="submit">Agregar Tercero</button>
                </form>
                
                <h3>Terceros Registrados</h3>
                <table id="terceros-table">
                    <thead>
                        <tr>
                            <th>NIT</th>
                            <th>Razón Social</th>
                            <th class="actions-header requires-editor" style="display: none;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="terceros-tbody">
                        </tbody>
                </table>
            </section>
            
            <section id="consumos" class="section">
                <h2>Gestión de Consumos y Facturas</h2>
                <div id="consumos-alert" class="alert" style="display: none;"></div>
                
                <div class="requires-editor" style="display: none;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="aplicar-retencion-renta">
                        <label for="aplicar-retencion-renta">Aplicar Retención en la Fuente de Renta</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="aplicar-retencion-ica">
                        <label for="aplicar-retencion-ica">Aplicar Retención de ICA</label>
                    </div>
                    
                    <div class="tab-nav" id="consumos-tab-nav">
                        <button class="tab-nav-button active" data-target="tab-consumo">Agregar Consumo</button>
                        <button class="tab-nav-button" data-target="tab-factura">Agregar Factura</button>
                        <button class="tab-nav-button" data-target="tab-factura-adicional">Fact. Adicional</button>
                        <button class="tab-nav-button" data-target="tab-recibo">Recibo Contado</button>
                        <button class="tab-nav-button" data-target="tab-importar-facturas">Importar CSV</button>
                    </div>

                    <div id="tab-consumo" class="tab-content active">
                        <h3>Agregar Consumo</h3>
                        <form id="consumo-form">
                            <div class="form-group">
                                <label for="tercero-consumo">Tercero</label>
                                <select id="tercero-consumo" required>
                                    <option value="">Seleccione un tercero</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fecha-consumo">Fecha del Consumo</label>
                                <input type="date" id="fecha-consumo" required>
                            </div>
                            <div class="form-group">
                                <label for="valor-consumo">Valor del Consumo</label>
                                <input type="number" id="valor-consumo" min="0" step="0.01" required>
                            </div>
                            <button type="submit">Agregar Consumo</button>
                        </form>
                    </div>
                    
                    <div id="tab-factura" class="tab-content">
                        <h3>Agregar Factura</h3>
                        <form id="factura-form">
                            <div class="form-group">
                                <label for="tercero-factura">Tercero</label>
                                <select id="tercero-factura" required>
                                    <option value="">Seleccione un tercero</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fecha-factura">Fecha de la Factura</label>
                                <input type="date" id="fecha-factura" required>
                            </div>
                            <div class="form-group">
                                <label for="no-documento-factura">Número de Documento</label>
                                <input type="text" id="no-documento-factura" required>
                            </div>
                            <div class="form-group">
                                <label for="valor-factura">Valor de la Factura</label>
                                <input type="number" id="valor-factura" min="0" step="0.01" required>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="factura-borrador" checked>
                                <label for="factura-borrador">Factura en estado borrador</label>
                            </div>
                            <button type="submit">Agregar Factura</button>
                        </form>
                    </div>
                    
                    <div id="tab-factura-adicional" class="tab-content">
                        <h3>Agregar Factura Adicional</h3>
                        <form id="factura-adicional-form">
                            <div class="form-group">
                                <label for="tercero-factura-adicional">Tercero</label>
                                <select id="tercero-factura-adicional" required>
                                    <option value="">Seleccione un tercero</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fecha-factura-adicional">Fecha</label>
                                <input type="date" id="fecha-factura-adicional" required>
                            </div>
                            <div class="form-group">
                                <label for="no-documento-factura-adicional">Número de Documento (prefijo ASFE)</label>
                                <input type="text" id="no-documento-factura-adicional" required>
                            </div>
                            <div class="form-group">
                                <label for="valor-factura-adicional">Valor</label>
                                <input type="number" id="valor-factura-adicional" min="0" step="0.01" required>
                            </div>
                            <button type="submit">Agregar Factura Adicional</button>
                        </form>
                    </div>
                    
                    <div id="tab-recibo" class="tab-content">
                        <h3>Agregar Recibo de Contado</h3>
                        <form id="recibo-contado-form">
                            <div class="form-group">
                                <label for="tercero-recibo">Tercero</label>
                                <select id="tercero-recibo" required>
                                    <option value="">Seleccione un tercero</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fecha-recibo">Fecha</label>
                                <input type="date" id="fecha-recibo" required>
                            </div>
                            <div class="form-group">
                                <label for="no-documento-recibo">Número de Documento (debe incluir **)</label>
                                <input type="text" id="no-documento-recibo" required>
                            </div>
                            <div class="form-group">
                                <label for="valor-recibo">Valor (negativo)</label>
                                <input type="number" id="valor-recibo" max="0" step="0.01" required>
                            </div>
                            <button type="submit">Agregar Recibo de Contado</button>
                        </form>
                    </div>
                    
                    <div id="tab-importar-facturas" class="tab-content">
                        <h3>Importar Facturas desde CSV</h3>
                        <p class="import-note">
                            El archivo CSV debe tener 4 columnas, separadas por coma (,) y sin encabezado:
                            <br>
                            <strong>NIT_Tercero, Fecha (YYYY-MM-DD), No_Documento, Valor</strong>
                            <br>
                            <em>Nota: Todas las facturas se importarán como "factura" en estado "borrador". El NIT debe existir previamente en la sección "Terceros".</em>
                        </p>
                        <div class="form-group">
                            <label for="csv-facturas-input">Seleccionar archivo CSV</label>
                            <input type="file" id="csv-facturas-input" accept=".csv">
                        </div>
                        <button id="importar-facturas-btn" class="success" style="width: auto; padding: 0.75rem 1.5rem;">Importar Facturas CSV</button>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;">Registros de Consumos y Facturas</h3>
                <table id="consumos-table">
                    <thead>
                        <tr>
                            <th>Tercero</th>
                            <th>Fecha</th>
                            <th>No. Documento</th>
                            <th>Valor</th>
                            <th>Retención Renta</th>
                            <th>Retención ICA</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th class="actions-header requires-editor" style="display: none;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="consumos-tbody">
                        </tbody>
                </table>
            </section>
            
            <section id="anticipos" class="section">
                <h2>Gestión de Anticipos</h2>
                <div id="anticipos-alert" class="alert" style="display: none;"></div>
                
                <div class="requires-editor" style="display: none;">
                    <div class="tab-nav" id="anticipos-tab-nav">
                        <button class="tab-nav-button active" data-target="tab-anticipo-manual">Agregar Anticipo</button>
                        <button class="tab-nav-button" data-target="tab-importar-anticipos">Importar CSV</button>
                    </div>

                    <div id="tab-anticipo-manual" class="tab-content active">
                        <h3>Agregar Anticipo</h3>
                        <form id="anticipo-form">
                            <div class="form-group">
                                <label for="tercero-anticipo">Tercero</label>
                                <select id="tercero-anticipo" required>
                                    <option value="">Seleccione un tercero</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fecha-anticipo">Fecha del Anticipo</label>
                                <input type="date" id="fecha-anticipo" required>
                            </div>
                            <div class="form-group">
                                <label for="no-documento-anticipo">Número de Documento</label>
                                <input type="text" id="no-documento-anticipo" required>
                            </div>
                            <div class="form-group">
                                <label for="valor-anticipo">Valor del Anticipo</label>
                                <input type="number" id="valor-anticipo" min="0" step="0.01" required>
                            </div>
                            <button type="submit">Agregar Anticipo</button>
                        </form>
                    </div>
                    
                    <div id="tab-importar-anticipos" class="tab-content">
                        <h3>Importar Anticipos desde CSV</h3>
                        <p class="import-note">
                            El archivo CSV debe tener 4 columnas, separadas por coma (,) y sin encabezado:
                            <br>
                            <strong>NIT_Tercero, Fecha (YYYY-MM-DD), No_Documento, Valor</strong>
                            <br>
                            <em>Nota: El NIT debe existir previamente en la sección "Terceros".</em>
                        </p>
                        <div class="form-group">
                            <label for="csv-anticipos-input">Seleccionar archivo CSV</label>
                            <input type="file" id="csv-anticipos-input" accept=".csv">
                        </div>
                        <button id="importar-anticipos-btn" class="success" style="width: auto; padding: 0.75rem 1.5rem;">Importar Anticipos CSV</button>
                    </div>
                </div>
                
                <h3 style="margin-top: 2rem;">Anticipos Registrados</h3>
                <table id="anticipos-table">
                    <thead>
                        <tr>
                            <th>Tercero</th>
                            <th>Fecha</th>
                            <th>No. Documento</th>
                            <th>Valor</th>
                            <th class="actions-header requires-editor" style="display: none;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="anticipos-tbody">
                        </tbody>
                </table>
            </section>
            
            <section id="estado-cuenta" class="section">
                <h2>Estado de Cuenta</h2>
                
                <div class="tercero-selector">
                    <label for="tercero-estado-cuenta">Seleccionar Tercero:</label>
                    <select id="tercero-estado-cuenta">
                        <option value="">Todos los terceros</option>
                    </select>
                </div>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>TOTAL ANTICIPOS</h3>
                        <div class="value" id="total-anticipos">0</div>
                        <div class="label">Acumulado a la fecha</div>
                    </div>
                    
                    <div class="card">
                        <h3>TOTAL CONSUMOS</h3>
                        <div class="value" id="total-consumos">0</div>
                        <div class="label">Acumulado a la fecha</div>
                    </div>
                    
                    <div class="card" id="saldo-card">
                        <h3>SALDO</h3>
                        <div class="value" id="saldo">0</div>
                        <div class="label" id="fecha-saldo">al [fecha]</div>
                    </div>
                </div>
                
                <h3>Detalle de Consumos y Facturas</h3>
                <table id="estado-consumos-table">
                    <thead>
                        <tr>
                            <th>Tercero</th>
                            <th>Fecha</th>
                            <th>No. Documento</th>
                            <th>Valor</th>
                            <th>Retención Renta</th>
                            <th>Retención ICA</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="estado-consumos-tbody">
                        </tbody>
                </table>
                
                <h3>Detalle de Anticipos</h3>
                <table id="estado-anticipos-table">
                    <thead>
                        <tr>
                            <th>Tercero</th>
                            <th>Fecha</th>
                            <th>No. Documento</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody id="estado-anticipos-tbody">
                        </tbody>
                </table>
                
                <div class="export-options">
                    <button class="success" id="exportar-pdf">Exportar a PDF</button>
                    <button class="success" id="exportar-docx">Exportar a DOCX</button>
                </div>
            </section>

            <section id="admin" class="section requires-admin" style="display: none;">
                <h2>Administración de Usuarios</h2>
                <div id="admin-alert" class="alert" style="display: none;"></div>
                
                <h3>Usuarios Registrados</h3>
                <p class="import-note">
                    Los nuevos usuarios deben registrarse en la pantalla de inicio. Aquí puedes cambiar su rol de "viewer" (consulta) a "editor" o "admin".
                </p>
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Rol Actual</th>
                            <th>Cambiar Rol</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        </tbody>
                </table>
            </section>
            </div>
    </div>
    
<script type="module" src="control-combustible.js">
        // ----------------------------------------------------
        // ⬇️ ¡PEGA AQUÍ TU CONFIGURACIÓN DE FIREBASE! ⬇️
        // ----------------------------------------------------
        // Reemplaza esto con el objeto de configuración de tu proyecto
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        const firebaseConfig = {
            apiKey: "AIzaSyDs0S4ckp8a3CowADsF5VWKFeLe1cytIKQ",
            authDomain: "ejgam1997-source.github.io",
            projectId: "estados-de-cuenta-d798e",
            storageBucket: "estados-de-cuenta-d798e.firebasestorage.app",
            messagingSenderId: "936988926580",
            appId: "1:936988926580:web:bb2e68f23bdb83b5236721"
        };
        // ----------------------------------------------------
        // ⬆️ ¡PEGA AQUÍ TU CONFIGURACIÓN DE FIREBASE! ⬆️
        // ----------------------------------------------------

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Referencias a los servicios de Firebase
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Estado global de la aplicación
        let currentUserRole = 'viewer';
        let localTerceros = []; // Mantenemos una copia local para los selectores
        
        // Configuración de retenciones (se sigue guardando localmente)
        let aplicarRetencionRenta = localStorage.getItem('aplicarRetencionRenta') === 'true';
        let aplicarRetencionICA = localStorage.getItem('aplicarRetencionICA') === 'true';
        
        // Tercero seleccionado para estado de cuenta
        let terceroSeleccionado = '';
        
        // Listeners globales para listeners de DB (para poder "desactivarlos" al hacer logout)
        let unlistenTerceros = () => {};
        let unlistenConsumos = () => {};
        let unlistenAnticipos = () => {};
        let unlistenUsers = () => {};
        
        // --- INICIO: Lógica de Autenticación y Roles ---

        document.addEventListener('DOMContentLoaded', function() {
            // Manejador del estado de autenticación
            auth.onAuthStateChanged(handleAuthStateChange);
            
            // Listeners de formularios de login/registro
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // Toggle entre login y registro
            document.getElementById('show-register-btn').addEventListener('click', () => toggleLogin(false));
            document.getElementById('show-login-btn').addEventListener('click', () => toggleLogin(true));

            // Configurar navegación
            setupNavigation();

            // Configurar checkboxes de retenciones
            setupRetencionCheckboxes();
            
            // Configurar formularios
            setupForms();
            
            // Listeners para importación CSV
            document.getElementById('importar-facturas-btn').addEventListener('click', importarFacturasCSV);
            document.getElementById('importar-anticipos-btn').addEventListener('click', importarAnticiposCSV);

            // Configurar pestañas (Tabs)
            setupTabs('consumos-tab-nav');
            setupTabs('anticipos-tab-nav');
            
            // Configurar selector de tercero en estado de cuenta
            document.getElementById('tercero-estado-cuenta').addEventListener('change', function() {
                terceroSeleccionado = this.value;
                actualizarEstadoCuenta();
            });
            
            // Configurar botones de exportación
            document.getElementById('exportar-pdf').addEventListener('click', exportarPDF);
            document.getElementById('exportar-docx').addEventListener('click', exportarDOCX);
        });

        function toggleLogin(isLogin) {
            const title = document.getElementById('login-title');
            const btn = document.getElementById('login-btn');
            const loginForm = document.getElementById('login-form');
            const loginText = document.getElementById('login-text');
            const registerText = document.getElementById('register-text');

            if (isLogin) {
                title.textContent = 'Iniciar Sesión';
                btn.textContent = 'Ingresar';
                loginForm.onsubmit = handleLogin;
                loginText.style.display = 'block';
                registerText.style.display = 'none';
            } else {
                title.textContent = 'Crear Cuenta';
                btn.textContent = 'Registrarse';
                loginForm.onsubmit = handleRegister;
                loginText.style.display = 'none';
                registerText.style.display = 'block';
            }
            document.getElementById('login-alert').style.display = 'none';
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    mostrarAlerta('login-alert', 'error', traducirErrorFirebase(error.code));
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // ¡Usuario creado! Ahora creamos su documento de rol en Firestore
                    // Por defecto, todos los nuevos usuarios son 'viewer'
                    return db.collection('users').doc(userCredential.user.uid).set({
                        email: userCredential.user.email,
                        role: 'viewer'
                    });
                })
                .then(() => {
                    // El listener onAuthStateChanged se encargará del resto
                })
                .catch((error) => {
                    mostrarAlerta('login-alert', 'error', traducirErrorFirebase(error.code));
                });
        }

        function handleLogout() {
            auth.signOut();
        }

        function handleAuthStateChange(user) {
            if (user) {
                // Usuario está conectado
                // 1. Obtener su rol de Firestore
                db.collection('users').doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists) {
                            currentUserRole = doc.data().role;
                        } else {
                            // Caso raro: Auth existe pero no hay doc en Firestore. 
                            // Lo creamos como viewer.
                            currentUserRole = 'viewer';
                            db.collection('users').doc(user.uid).set({ email: user.email, role: 'viewer' });
                        }
                        
                        // 2. Configurar UI
                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        document.getElementById('user-info').textContent = `Usuario: ${user.email} (${currentUserRole})`;
                        
                        // 3. Aplicar permisos
                        applyRolePermissions(currentUserRole);

                        // 4. Activar listeners de la base de datos
                        listenForTerceros();
                        listenForConsumos();
                        listenForAnticipos();
                        if (currentUserRole === 'admin') {
                            listenForAdminPanel();
                        }
                    })
                    .catch(err => {
                        console.error("Error al obtener rol de usuario:", err);
                        handleLogout(); // Forzar cierre de sesión si hay error de permisos
                    });
                
            } else {
                // Usuario está desconectado
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
                currentUserRole = 'viewer';
                
                // Limpiar listeners para evitar fugas de memoria
                unlistenTerceros();
                unlistenConsumos();
                unlistenAnticipos();
                unlistenUsers();

                // Limpiar tablas
                document.getElementById('terceros-tbody').innerHTML = '';
                document.getElementById('consumos-tbody').innerHTML = '';
                document.getElementById('anticipos-tbody').innerHTML = '';
                document.getElementById('users-tbody').innerHTML = '';
            }
        }
        
        function applyRolePermissions(role) {
            const editorElements = document.querySelectorAll('.requires-editor');
            const adminElements = document.querySelectorAll('.requires-admin');

            if (role === 'admin') {
                editorElements.forEach(el => el.style.display = '');
                adminElements.forEach(el => el.style.display = '');
            } else if (role === 'editor') {
                editorElements.forEach(el => el.style.display = '');
                adminElements.forEach(el => el.style.display = 'none');
            } else { // viewer
                editorElements.forEach(el => el.style.display = 'none');
                adminElements.forEach(el => el.style.display = 'none');
            }
        }
        
        function traducirErrorFirebase(code) {
            switch (code) {
                case 'auth/wrong-password':
                    return 'Contraseña incorrecta.';
                case 'auth/user-not-found':
                    return 'No se encontró usuario con ese email.';
                case 'auth/invalid-email':
                    return 'Email no válido.';
                case 'auth/email-already-in-use':
                    return 'Ese email ya está en uso.';
                case 'auth/weak-password':
                    return 'La contraseña debe tener al menos 6 caracteres.';
                default:
                    return 'Error de autenticación. Intenta de nuevo.';
            }
        }

        // --- INICIO: Funciones de Admin ---
        function listenForAdminPanel() {
            // Escuchar cambios en la colección de usuarios
            unlistenUsers = db.collection('users').onSnapshot((snapshot) => {
                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const tr = document.createElement('tr');
                    
                    const roleSelect = `
                        <select onchange="adminChangeRole('${doc.id}', this.value)">
                            <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Consulta (viewer)</option>
                            <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Emisor (editor)</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin (admin)</option>
                        </select>
                    `;
                    
                    tr.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>${roleSelect}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // Esta función ahora es llamada por el <select> en la tabla
        function adminChangeRole(uid, newRole) {
            db.collection('users').doc(uid).update({
                role: newRole
            })
            .then(() => {
                mostrarAlerta('admin-alert', 'success', 'Rol actualizado correctamente.');
            })
            .catch(err => {
                mostrarAlerta('admin-alert', 'error', 'Error al actualizar el rol.');
            });
        }
        
        // --- FIN: Funciones de Admin ---


        // Funciones para Terceros
        function listenForTerceros() {
            unlistenTerceros = db.collection('terceros').orderBy('razonSocial').onSnapshot((snapshot) => {
                const tbody = document.getElementById('terceros-tbody');
                tbody.innerHTML = '';
                localTerceros = []; // Reiniciar la copia local

                const showActions = currentUserRole === 'admin' || currentUserRole === 'editor';
                document.querySelector('#terceros-table .actions-header').style.display = showActions ? '' : 'none';

                snapshot.forEach(doc => {
                    const tercero = doc.data();
                    tercero.id = doc.id; // Guardamos el ID del documento
                    localTerceros.push(tercero); // Guardar en copia local

                    const tr = document.createElement('tr');
                    let actionsHTML = '';
                    if (showActions) {
                        actionsHTML = `
                            <td class="actions">
                                <button class="danger" onclick="eliminarTercero('${tercero.id}')">Eliminar</button>
                            </td>`;
                    }

                    tr.innerHTML = `
                        <td>${tercero.nit}</td>
                        <td>${tercero.razonSocial}</td>
                        ${actionsHTML}
                    `;
                    tbody.appendChild(tr);
                });
                
                // Actualizar todos los <select> de terceros
                actualizarSelectoresTerceros();
            });
        }
        
        function agregarTercero(e) {
            e.preventDefault();
            
            const nit = document.getElementById('nit').value;
            const razonSocial = document.getElementById('razon-social').value;
            
            // Validar que no exista ya el NIT (usando la copia local)
            if (localTerceros.some(tercero => tercero.nit === nit)) {
                mostrarAlerta('terceros-alert', 'error', 'Ya existe un tercero con ese NIT.');
                return;
            }
            
            db.collection('terceros').add({
                nit,
                razonSocial
            })
            .then(() => {
                document.getElementById('tercero-form').reset();
                mostrarAlerta('terceros-alert', 'success', 'Tercero agregado correctamente.');
            })
            .catch(err => {
                mostrarAlerta('terceros-alert', 'error', 'Error al agregar tercero.');
            });
        }
        
        async function eliminarTercero(docId) {
            // Verificar si hay consumos o anticipos asociados a este tercero
            // Esta es una verificación de seguridad de bajo nivel
            const tercero = localTerceros.find(t => t.id === docId);
            if (!tercero) return;

            const consumosQuery = await db.collection('consumos').where('terceroId', '==', tercero.id).limit(1).get();
            const anticiposQuery = await db.collection('anticipos').where('terceroId', '==', tercero.id).limit(1).get();

            if (!consumosQuery.empty || !anticiposQuery.empty) {
                mostrarAlerta('terceros-alert', 'error', 'No se puede eliminar el tercero porque tiene consumos o anticipos asociados.');
                return;
            }

            if (confirm('¿Está seguro de que desea eliminar este tercero?')) {
                db.collection('terceros').doc(docId).delete()
                    .then(() => {
                        mostrarAlerta('terceros-alert', 'success', 'Tercero eliminado correctamente.');
                    })
                    .catch(err => {
                        mostrarAlerta('terceros-alert', 'error', 'Error al eliminar tercero.');
                    });
            }
        }
        
        function actualizarSelectoresTerceros() {
            const selectores = [
                'tercero-consumo',
                'tercero-factura',
                'tercero-factura-adicional',
                'tercero-recibo',
                'tercero-anticipo',
                'tercero-estado-cuenta'
            ];
            
            selectores.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                const valorActual = selector.value;
                
                selector.innerHTML = selectorId === 'tercero-estado-cuenta' 
                    ? '<option value="">Todos los terceros</option>' 
                    : '<option value="">Seleccione un tercero</option>';
                
                localTerceros.forEach(tercero => {
                    const option = document.createElement('option');
                    option.value = tercero.id; // Usamos el ID del documento
                    option.textContent = `${tercero.nit} - ${tercero.razonSocial}`;
                    selector.appendChild(option);
                });
                
                if (valorActual) {
                    selector.value = valorActual;
                }
            });
        }
        
        function obtenerTerceroPorId(id) {
            return localTerceros.find(tercero => tercero.id === id) || { nit: 'N/A', razonSocial: 'Tercero no encontrado' };
        }
        
        // Funciones para Consumos y Facturas
        function listenForConsumos() {
            unlistenConsumos = db.collection('consumos').orderBy('fecha', 'desc').onSnapshot((snapshot) => {
                const tbody = document.getElementById('consumos-tbody');
                tbody.innerHTML = '';
                
                const showActions = currentUserRole === 'admin' || currentUserRole === 'editor';
                document.querySelector('#consumos-table .actions-header').style.display = showActions ? '' : 'none';
                
                snapshot.forEach(doc => {
                    const consumo = doc.data();
                    const tercero = obtenerTerceroPorId(consumo.terceroId);
                    const tr = document.createElement('tr');
                    
                    let noDocumento = consumo.noDocumento || '-';
                    let estadoHTML = '';
                    
                    if (consumo.tipo === 'factura') {
                        estadoHTML = `<span class="status-badge ${consumo.estado}">${consumo.estado === 'borrador' ? 'Borrador' : 'Completada'}</span>`;
                    } else {
                        estadoHTML = '-';
                    }
                    
                    let accionesHTML = '';
                    if (showActions) {
                        let actionsContent = `<button class="danger" onclick="eliminarConsumo('${doc.id}')">Eliminar</button>`;
                        if (consumo.tipo === 'factura' && consumo.estado === 'borrador') {
                            actionsContent += `<button class="success" onclick="completarFactura('${doc.id}')">Completar</button>`;
                        }
                        accionesHTML = `<td class="actions">${actionsContent}</td>`;
                    }
                    
                    tr.innerHTML = `
                        <td>${tercero.razonSocial}</td>
                        <td>${formatearFecha(consumo.fecha)}</td>
                        <td>${noDocumento}</td>
                        <td>${formatearMoneda(consumo.valor)}</td>
                        <td>${formatearMoneda(consumo.retencionRenta)}</td>
                        <td>${formatearMoneda(consumo.retencionICA)}</td>
                        <td>${formatearMoneda(consumo.total)}</td>
                        <td>${estadoHTML}</td>
                        ${accionesHTML}
                    `;
                    tbody.appendChild(tr);
                });

                // Cada vez que cambian los consumos, actualizamos el estado de cuenta
                actualizarEstadoCuenta();
            });
        }
        
        function agregarConsumo(e) {
            e.preventDefault();
            
            const terceroId = document.getElementById('tercero-consumo').value;
            const fecha = document.getElementById('fecha-consumo').value;
            const valor = parseFloat(document.getElementById('valor-consumo').value);
            
            const nuevoConsumo = {
                terceroId,
                fecha,
                tipo: 'consumo',
                valor,
                retencionRenta: aplicarRetencionRenta ? valor * 0.001 : 0,
                retencionICA: aplicarRetencionICA ? valor * 0.0138 : 0,
                total: calcularTotal(valor, aplicarRetencionRenta, aplicarRetencionICA)
            };
            
            db.collection('consumos').add(nuevoConsumo)
                .then(() => {
                    document.getElementById('consumo-form').reset();
                    mostrarAlerta('consumos-alert', 'success', 'Consumo agregado correctamente.');
                })
                .catch(err => {
                    mostrarAlerta('consumos-alert', 'error', 'Error al agregar consumo.');
                });
        }
        
        function agregarFactura(e) {
            e.preventDefault();
            
            const terceroId = document.getElementById('tercero-factura').value;
            const fecha = document.getElementById('fecha-factura').value;
            const noDocumento = document.getElementById('no-documento-factura').value;
            const valor = parseFloat(document.getElementById('valor-factura').value);
            const borrador = document.getElementById('factura-borrador').checked;
            
            const nuevaFactura = {
                terceroId,
                fecha,
                tipo: 'factura',
                noDocumento,
                valor,
                estado: borrador ? 'borrador' : 'completada',
                retencionRenta: aplicarRetencionRenta ? valor * 0.001 : 0,
                retencionICA: aplicarRetencionICA ? valor * 0.0138 : 0,
                total: calcularTotal(valor, aplicarRetencionRenta, aplicarRetencionICA)
            };
            
            db.collection('consumos').add(nuevaFactura)
                .then(() => {
                    document.getElementById('factura-form').reset();
                    mostrarAlerta('consumos-alert', 'success', 'Factura agregada correctamente.');
                })
                .catch(err => {
                    mostrarAlerta('consumos-alert', 'error', 'Error al agregar factura.');
                });
        }
        
        function agregarFacturaAdicional(e) {
            e.preventDefault();
            
            const terceroId = document.getElementById('tercero-factura-adicional').value;
            const fecha = document.getElementById('fecha-factura-adicional').value;
            const noDocumento = document.getElementById('no-documento-factura-adicional').value;
            const valor = parseFloat(document.getElementById('valor-factura-adicional').value);
            
            if (!noDocumento.startsWith('ASFE')) {
                mostrarAlerta('consumos-alert', 'error', 'El número de documento debe empezar con "ASFE".');
                return;
            }
            
            const nuevaFacturaAdicional = {
                terceroId,
                fecha,
                tipo: 'factura-adicional',
                noDocumento,
                valor,
                estado: 'completada',
                retencionRenta: 0,
                retencionICA: 0,
                total: valor
            };
            
            db.collection('consumos').add(nuevaFacturaAdicional)
                .then(() => {
                    document.getElementById('factura-adicional-form').reset();
                    mostrarAlerta('consumos-alert', 'success', 'Factura adicional agregada.');
                })
                .catch(err => {
                    mostrarAlerta('consumos-alert', 'error', 'Error al agregar factura.');
                });
        }
        
        function agregarReciboContado(e) {
            e.preventDefault();
            
            const terceroId = document.getElementById('tercero-recibo').value;
            const fecha = document.getElementById('fecha-recibo').value;
            const noDocumento = document.getElementById('no-documento-recibo').value;
            const valor = parseFloat(document.getElementById('valor-recibo').value);
            
            if (!noDocumento.includes('**')) {
                mostrarAlerta('consumos-alert', 'error', 'El número de documento debe incluir "**".');
                return;
            }
            
            if (valor >= 0) {
                mostrarAlerta('consumos-alert', 'error', 'El valor debe ser negativo.');
                return;
            }
            
            const nuevoReciboContado = {
                terceroId,
                fecha,
                tipo: 'recibo-contado',
                noDocumento,
                valor,
                estado: 'completada',
                retencionRenta: 0,
                retencionICA: 0,
                total: valor
            };
            
            db.collection('consumos').add(nuevoReciboContado)
                .then(() => {
                    document.getElementById('recibo-contado-form').reset();
                    mostrarAlerta('consumos-alert', 'success', 'Recibo de contado agregado.');
                })
                .catch(err => {
                    mostrarAlerta('consumos-alert', 'error', 'Error al agregar recibo.');
                });
        }
        
        function completarFactura(docId) {
            db.collection('consumos').doc(docId).update({
                estado: 'completada'
            })
            .then(() => {
                mostrarAlerta('consumos-alert', 'success', 'Factura completada.');
            })
            .catch(err => {
                mostrarAlerta('consumos-alert', 'error', 'Error al completar factura.');
            });
        }
        
        function eliminarConsumo(docId) {
            if (confirm('¿Está seguro de que desea eliminar este registro?')) {
                db.collection('consumos').doc(docId).delete()
                    .then(() => {
                        mostrarAlerta('consumos-alert', 'success', 'Registro eliminado.');
                    })
                    .catch(err => {
                        mostrarAlerta('consumos-alert', 'error', 'Error al eliminar.');
                    });
            }
        }
        
        // Funciones para Anticipos
        function listenForAnticipos() {
            unlistenAnticipos = db.collection('anticipos').orderBy('fecha', 'desc').onSnapshot((snapshot) => {
                const tbody = document.getElementById('anticipos-tbody');
                tbody.innerHTML = '';
                
                const showActions = currentUserRole === 'admin' || currentUserRole === 'editor';
                document.querySelector('#anticipos-table .actions-header').style.display = showActions ? '' : 'none';

                snapshot.forEach(doc => {
                    const anticipo = doc.data();
                    const tercero = obtenerTerceroPorId(anticipo.terceroId);
                    const tr = document.createElement('tr');

                    let actionsHTML = '';
                    if (showActions) {
                        actionsHTML = `
                            <td class="actions">
                                <button class="danger" onclick="eliminarAnticipo('${doc.id}')">Eliminar</button>
                            </td>`;
                    }

                    tr.innerHTML = `
                        <td>${tercero.razonSocial}</td>
                        <td>${formatearFecha(anticipo.fecha)}</td>
                        <td>${anticipo.noDocumento}</td>
                        <td>${formatearMoneda(anticipo.valor)}</td>
                        ${actionsHTML}
                    `;
                    tbody.appendChild(tr);
                });

                // Cada vez que cambian los anticipos, actualizamos el estado de cuenta
                actualizarEstadoCuenta();
            });
        }
        
        function agregarAnticipo(e) {
            e.preventDefault();
            
            const terceroId = document.getElementById('tercero-anticipo').value;
            const fecha = document.getElementById('fecha-anticipo').value;
            const noDocumento = document.getElementById('no-documento-anticipo').value;
            const valor = parseFloat(document.getElementById('valor-anticipo').value);
            
            const nuevoAnticipo = {
                terceroId,
                fecha,
                noDocumento,
                valor
            };
            
            db.collection('anticipos').add(nuevoAnticipo)
                .then(() => {
                    document.getElementById('anticipo-form').reset();
                    mostrarAlerta('anticipos-alert', 'success', 'Anticipo agregado.');
                })
                .catch(err => {
                    mostrarAlerta('anticipos-alert', 'error', 'Error al agregar anticipo.');
                });
        }
        
        function eliminarAnticipo(docId) {
            if (confirm('¿Está seguro de que desea eliminar este anticipo?')) {
                db.collection('anticipos').doc(docId).delete()
                    .then(() => {
                        mostrarAlerta('anticipos-alert', 'success', 'Anticipo eliminado.');
                    })
                    .catch(err => {
                        mostrarAlerta('anticipos-alert', 'error', 'Error al eliminar.');
                    });
            }
        }
        
        // Funciones para Estado de Cuenta
        async function actualizarEstadoCuenta() {
            // Esta función ahora CONSULTA a Firestore según los filtros
            
            let consumosQuery = db.collection('consumos');
            let anticiposQuery = db.collection('anticipos');
            
            if (terceroSeleccionado) {
                consumosQuery = consumosQuery.where('terceroId', '==', terceroSeleccionado);
                anticiposQuery = anticiposQuery.where('terceroId', '==', terceroSeleccionado);
            }
            
            try {
                const [consumosSnapshot, anticiposSnapshot] = await Promise.all([
                    consumosQuery.get(),
                    anticiposQuery.get()
                ]);

                const consumosFiltrados = consumosSnapshot.docs.map(doc => doc.data());
                const anticiposFiltrados = anticiposSnapshot.docs.map(doc => doc.data());

                // Calcular totales
                const totalAnticipos = anticiposFiltrados.reduce((sum, anticipo) => sum + anticipo.valor, 0);
                const totalConsumos = consumosFiltrados.reduce((sum, consumo) => sum + consumo.total, 0);
                const saldo = totalAnticipos - totalConsumos;
                
                // Actualizar tarjetas
                document.getElementById('total-anticipos').textContent = formatearMoneda(totalAnticipos);
                document.getElementById('total-consumos').textContent = formatearMoneda(totalConsumos);
                
                const saldoElement = document.getElementById('saldo');
                const saldoCard = document.getElementById('saldo-card');
                
                if (saldo >= 0) {
                    saldoElement.textContent = formatearMoneda(saldo);
                    saldoCard.classList.remove('negative');
                    saldoCard.classList.add('positive');
                } else {
                    saldoElement.textContent = formatearMoneda(saldo);
                    saldoCard.classList.remove('positive');
                    saldoCard.classList.add('negative');
                }
                
                // Actualizar fecha de saldo
                let ultimaFechaConsumo = '';
                if (consumosFiltrados.length > 0) {
                    const fechasConsumos = consumosFiltrados.map(c => new Date(c.fecha));
                    const fechaMasReciente = new Date(Math.max(...fechasConsumos));
                    ultimaFechaConsumo = formatearFecha(fechaMasReciente.toISOString().split('T')[0]);
                } else {
                    ultimaFechaConsumo = formatearFecha(new Date().toISOString().split('T')[0]);
                }
                document.getElementById('fecha-saldo').textContent = `al ${ultimaFechaConsumo}`;
                
                // Actualizar tablas de detalle
                actualizarTablasDetalleEstadoCuenta(consumosFiltrados, anticiposFiltrados);

            } catch (err) {
                console.error("Error al actualizar estado de cuenta:", err);
            }
        }
        
        function actualizarTablasDetalleEstadoCuenta(consumosFiltrados, anticiposFiltrados) {
            const tbodyConsumos = document.getElementById('estado-consumos-tbody');
            tbodyConsumos.innerHTML = '';
            
            const fechaLimite = new Date();
            fechaLimite.setFullYear(fechaLimite.getFullYear() - 1);
            
            const consumosFiltradosAnio = consumosFiltrados.filter(consumo => new Date(consumo.fecha) >= fechaLimite);
            const consumosOrdenados = [...consumosFiltradosAnio].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            consumosOrdenados.forEach(consumo => {
                const tercero = obtenerTerceroPorId(consumo.terceroId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${tercero.razonSocial}</td>
                    <td>${formatearFecha(consumo.fecha)}</td>
                    <td>${consumo.noDocumento || '-'}</td>
                    <td>${formatearMoneda(consumo.valor)}</td>
                    <td>${formatearMoneda(consumo.retencionRenta)}</td>
                    <td>${formatearMoneda(consumo.retencionICA)}</td>
                    <td>${formatearMoneda(consumo.total)}</td>
                `;
                tbodyConsumos.appendChild(tr);
            });
            
            const tbodyAnticipos = document.getElementById('estado-anticipos-tbody');
            tbodyAnticipos.innerHTML = '';
            
            const anticiposFiltradosAnio = anticiposFiltrados.filter(anticipo => new Date(anticipo.fecha) >= fechaLimite);
            const anticiposOrdenados = [...anticiposFiltradosAnio].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            anticiposOrdenados.forEach(anticipo => {
                const tercero = obtenerTerceroPorId(anticipo.terceroId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${tercero.razonSocial}</td>
                    <td>${formatearFecha(anticipo.fecha)}</td>
                    <td>${anticipo.noDocumento}</td>
                    <td>${formatearMoneda(anticipo.valor)}</td>
                `;
                tbodyAnticipos.appendChild(tr);
            });
        }
        
        
        // --- INICIO: Funciones de Importación CSV (con Lotes de Firebase) ---

        function importarFacturasCSV() {
            const input = document.getElementById('csv-facturas-input');
            if (!input.files || input.files.length === 0) {
                mostrarAlerta('consumos-alert', 'error', 'Por favor, seleccione un archivo CSV.');
                return;
            }
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    procesarCSVFacturas(e.target.result);
                } catch (error) {
                    console.error(error);
                    mostrarAlerta('consumos-alert', 'error', 'Error al procesar el archivo.');
                }
            };
            
            reader.readAsText(file);
            input.value = '';
        }

        async function procesarCSVFacturas(csvData) {
            const lines = csvData.split(/\r?\n/).filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                mostrarAlerta('consumos-alert', 'error', 'El archivo CSV está vacío.');
                return;
            }

            // Usar un BATCH de Firestore para importar eficientemente
            const batch = db.batch();
            let importados = 0;
            let errores = 0;
            
            for (const line of lines) {
                const parts = line.split(',');
                if (parts.length < 4) {
                    errores++; continue;
                }
                
                const nitTercero = parts[0].trim();
                const fecha = parts[1].trim();
                const noDocumento = parts[2].trim();
                const valor = parseFloat(parts[3].trim());
                
                // Buscar tercero en nuestra copia local
                const tercero = localTerceros.find(t => t.nit === nitTercero);
                
                if (!tercero || isNaN(valor)) {
                    errores++; continue;
                }

                const nuevaFactura = {
                    terceroId: tercero.id,
                    fecha: fecha,
                    tipo: 'factura',
                    noDocumento: noDocumento,
                    valor: valor,
                    estado: 'borrador',
                    retencionRenta: aplicarRetencionRenta ? valor * 0.001 : 0,
                    retencionICA: aplicarRetencionICA ? valor * 0.0138 : 0,
                    total: calcularTotal(valor, aplicarRetencionRenta, aplicarRetencionICA)
                };
                
                // Añadir al batch en lugar de llamar a .add()
                const docRef = db.collection('consumos').doc();
                batch.set(docRef, nuevaFactura);
                importados++;
            }
            
            // Enviar todo el lote a Firebase
            try {
                await batch.commit();
                mostrarAlerta('consumos-alert', 'success', `Importación completada. Agregados: ${importados}. Errores: ${errores}.`);
            } catch (err) {
                mostrarAlerta('consumos-alert', 'error', 'Error al guardar el lote en Firebase.');
            }
        }

        function importarAnticiposCSV() {
            const input = document.getElementById('csv-anticipos-input');
            if (!input.files || input.files.length === 0) {
                mostrarAlerta('anticipos-alert', 'error', 'Por favor, seleccione un archivo CSV.');
                return;
            }
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    procesarCSVAnticipos(e.target.result);
                } catch (error) {
                    console.error(error);
                    mostrarAlerta('anticipos-alert', 'error', 'Error al procesar el archivo.');
                }
            };
            
            reader.readAsText(file);
            input.value = '';
        }

        async function procesarCSVAnticipos(csvData) {
            const lines = csvData.split(/\r?\n/).filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                mostrarAlerta('anticipos-alert', 'error', 'El archivo CSV está vacío.');
                return;
            }
            
            const batch = db.batch();
            let importados = 0;
            let errores = 0;
            
            for (const line of lines) {
                const parts = line.split(',');
                if (parts.length < 4) {
                    errores++; continue;
                }
                
                const nitTercero = parts[0].trim();
                const fecha = parts[1].trim();
                const noDocumento = parts[2].trim();
                const valor = parseFloat(parts[3].trim());
                
                const tercero = localTerceros.find(t => t.nit === nitTercero);
                
                if (!tercero || isNaN(valor) || valor < 0) {
                    errores++; continue;
                }

                const nuevoAnticipo = {
                    terceroId: tercero.id,
                    fecha: fecha,
                    noDocumento: noDocumento,
                    valor: valor
                };
                
                const docRef = db.collection('anticipos').doc();
                batch.set(docRef, nuevoAnticipo);
                importados++;
            };
            
            try {
                await batch.commit();
                mostrarAlerta('anticipos-alert', 'success', `Importación completada. Agregados: ${importados}. Errores: ${errores}.`);
            } catch (err) {
                mostrarAlerta('anticipos-alert', 'error', 'Error al guardar el lote en Firebase.');
            }
        }

        // --- FIN: Funciones de Importación CSV ---


        // --- INICIO: Funciones de Configuración y Utilidad (Sin cambios) ---
        
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('data-target');
                    
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(target).classList.add('active');
                });
            });
        }

        function setupRetencionCheckboxes() {
            const rentaCheck = document.getElementById('aplicar-retencion-renta');
            const icaCheck = document.getElementById('aplicar-retencion-ica');
            
            rentaCheck.checked = aplicarRetencionRenta;
            icaCheck.checked = aplicarRetencionICA;
            
            rentaCheck.addEventListener('change', function() {
                aplicarRetencionRenta = this.checked;
                localStorage.setItem('aplicarRetencionRenta', aplicarRetencionRenta);
            });
            
            icaCheck.addEventListener('change', function() {
                aplicarRetencionICA = this.checked;
                localStorage.setItem('aplicarRetencionICA', aplicarRetencionICA);
            });
        }

        function setupForms() {
            document.getElementById('tercero-form').addEventListener('submit', agregarTercero);
            document.getElementById('consumo-form').addEventListener('submit', agregarConsumo);
            document.getElementById('factura-form').addEventListener('submit', agregarFactura);
            document.getElementById('factura-adicional-form').addEventListener('submit', agregarFacturaAdicional);
            document.getElementById('recibo-contado-form').addEventListener('submit', agregarReciboContado);
            document.getElementById('anticipo-form').addEventListener('submit', agregarAnticipo);
        }

        function setupTabs(navContainerId) {
            const navContainer = document.getElementById(navContainerId);
            if (!navContainer) return;
            const tabButtons = navContainer.querySelectorAll('.tab-nav-button');
            const tabContents = navContainer.parentElement.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    const targetContent = document.getElementById(button.getAttribute('data-target'));
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }
        
        function calcularTotal(valor, aplicarRenta, aplicarICA) {
            let total = valor;
            if (aplicarRenta) total -= valor * 0.001;
            if (aplicarICA) total -= valor * 0.0138;
            return total;
        }
        
        function formatearMoneda(valor) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }
        
        function formatearFecha(fecha) {
            const d = new Date(fecha);
            d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
            const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return d.toLocaleDateString('es-CO', opciones);
        }
        
        function mostrarAlerta(contenedorId, tipo, mensaje) {
            const contenedor = document.getElementById(contenedorId);
            contenedor.textContent = mensaje;
            contenedor.className = `alert ${tipo}`;
            contenedor.style.display = 'block';
            
            setTimeout(() => {
                contenedor.style.display = 'none';
            }, 5000);
        }
        
        // --- FIN: Funciones de Configuración y Utilidad ---


        // --- INICIO: Funciones de Exportación (Sin cambios) ---
        
        function exportarPDF() {
            document.getElementById('loading-overlay').style.display = 'flex';
            const terceroId = document.getElementById('tercero-estado-cuenta').value;
            const tercero = terceroId ? obtenerTerceroPorId(terceroId) : null;
            generarPDFNativo(tercero);
        }
        
        function generarPDFNativo(tercero) {
            const nombreArchivo = tercero 
                ? `Estado_Cuenta_${tercero.razonSocial.replace(/\s+/g, '_')}.pdf`
                : 'Estado_Cuenta_General.pdf';
            
            const totalAnticipos = document.getElementById('total-anticipos').textContent;
            const totalConsumos = document.getElementById('total-consumos').textContent;
            const saldo = document.getElementById('saldo').textContent;
            const fechaSaldo = document.getElementById('fecha-saldo').textContent;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'letter');
            
            const margin = 12;
            const pageWidth = 215.9;
            const pageHeight = 279.4;
            const contentWidth = pageWidth - (2 * margin);
            
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(16);
            pdf.setTextColor(44, 62, 80);
            pdf.text("ESTADO DE CUENTA", pageWidth / 2, margin + 10, { align: "center" });
            
            pdf.setDrawColor(44, 62, 80);
            pdf.setLineWidth(0.5);
            pdf.line(margin, margin + 15, pageWidth - margin, margin + 15);
            
            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            
            let yPos = margin + 25;
            
            pdf.text(`Empresa: SERVICIOS PARA VEHICULOS DE TRANSPORTE S.A.`, margin, yPos)
            if (tercero) {
                pdf.text(`Tercero: ${tercero.razonSocial}`, margin, yPos + 5);
                pdf.text(`NIT: ${tercero.nit}`, margin, yPos + 10);
            } else {
                pdf.text("Todos los terceros", margin, yPos);
            }
            
            pdf.text(`Fecha del estado: ${fechaSaldo}`, pageWidth - margin, yPos, { align: "right" });
            
            yPos += 15;
            
            const cardWidth = (contentWidth - 10) / 3;
            const cardHeight = 25;
            
            pdf.setFillColor(236, 240, 241);
            pdf.roundedRect(margin, yPos, cardWidth, cardHeight, 2, 2, 'F');
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(9);
            pdf.setTextColor(52, 73, 94);
            pdf.text("TOTAL ANTICIPOS", margin + (cardWidth / 2), yPos + 7, { align: "center" });
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0);
            pdf.text(totalAnticipos, margin + (cardWidth / 2), yPos + 17, { align: "center" });
            
            pdf.setFillColor(236, 240, 241);
            pdf.roundedRect(margin + cardWidth + 5, yPos, cardWidth, cardHeight, 2, 2, 'F');
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(9);
            pdf.setTextColor(52, 73, 94);
            pdf.text("TOTAL CONSUMOS", margin + cardWidth + 5 + (cardWidth / 2), yPos + 7, { align: "center" });
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0);
            pdf.text(totalConsumos, margin + cardWidth + 5 + (cardWidth / 2), yPos + 17, { align: "center" });
            
            pdf.setFillColor(236, 240, 241);
            pdf.roundedRect(margin + (2 * (cardWidth + 5)), yPos, cardWidth, cardHeight, 2, 2, 'F');
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(9);
            pdf.setTextColor(52, 73, 94);
            pdf.text("SALDO", margin + (2 * (cardWidth + 5)) + (cardWidth / 2), yPos + 7, { align: "center" });
            pdf.setFontSize(12);
            
            const saldoNum = parseFloat(saldo.replace(/[^0-9.-]+/g,""));
            if (saldoNum >= 0) {
                pdf.setTextColor(39, 174, 96);
            } else {
                pdf.setTextColor(231, 76, 60);
            }
            pdf.text(saldo, margin + (2 * (cardWidth + 5)) + (cardWidth / 2), yPos + 17, { align: "center" });
            
            yPos += cardHeight + 15;
            
            pdf.setTextColor(0, 0, 0);
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(12);
            pdf.text("DETALLE DE CONSUMOS Y FACTURAS", margin, yPos);
            
            yPos += 8;
            
            const tablaConsumos = document.getElementById('estado-consumos-table');
            const filasConsumos = tablaConsumos.querySelectorAll('tbody tr');
            
            pdf.setFillColor(44, 62, 80);
            pdf.rect(margin, yPos, contentWidth, 8, 'F');
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(8);
            pdf.setTextColor(255, 255, 255);
            pdf.text("Tercero", margin + 2, yPos + 5);
            pdf.text("Fecha", margin + 55, yPos + 5);
            pdf.text("Documento", margin + 75, yPos + 5);
            pdf.text("Valor", margin + 105, yPos + 5);
            pdf.text("Ret. Renta", margin + 125, yPos + 5);
            pdf.text("Ret. ICA", margin + 145, yPos + 5);
            pdf.text("Total", margin + 165, yPos + 5);
            
            yPos += 10;
            
            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(7);
            pdf.setTextColor(0, 0, 0);
            
            let filaIndex = 0;
            filasConsumos.forEach(fila => {
                if (yPos > pageHeight - margin - 10) {
                    pdf.addPage();
                    yPos = margin;
                    pdf.setFillColor(44, 62, 80);
                    pdf.rect(margin, yPos, contentWidth, 8, 'F');
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(8);
                    pdf.setTextColor(255, 255, 255);
                    pdf.text("Tercero", margin + 2, yPos + 5);
                    pdf.text("Fecha", margin + 55, yPos + 5);
                    pdf.text("Documento", margin + 75, yPos + 5);
                    pdf.text("Valor", margin + 105, yPos + 5);
                    pdf.text("Ret. Renta", margin + 125, yPos + 5);
                    pdf.text("Ret. ICA", margin + 145, yPos + 5);
                    pdf.text("Total", margin + 165, yPos + 5);
                    yPos += 10;
                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(7);
                }
                
                if (filaIndex % 2 === 0) {
                    pdf.setFillColor(249, 249, 249);
                    pdf.rect(margin, yPos, contentWidth, 6, 'F');
                }
                
                const celdas = fila.querySelectorAll('td');
                pdf.setTextColor(0, 0, 0);
                pdf.text(celdas[0].textContent.substring(0, 25), margin + 2, yPos + 4);
                pdf.text(celdas[1].textContent, margin + 55, yPos + 4);
                pdf.text(celdas[2].textContent.substring(0, 12), margin + 75, yPos + 4);
                pdf.text(celdas[3].textContent, margin + 105, yPos + 4);
                pdf.text(celdas[4].textContent, margin + 125, yPos + 4);
                pdf.text(celdas[5].textContent, margin + 145, yPos + 4);
                pdf.text(celdas[6].textContent, margin + 165, yPos + 4);
                
                yPos += 6;
                filaIndex++;
            });
            
            yPos += 10;
            
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(12);
            pdf.text("DETALLE DE ANTICIPOS", margin, yPos);
            
            yPos += 8;
            
            pdf.setFillColor(44, 62, 80);
            pdf.rect(margin, yPos, contentWidth, 8, 'F');
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(8);
            pdf.setTextColor(255, 255, 255);
            pdf.text("Tercero", margin + 2, yPos + 5);
            pdf.text("Fecha", margin + 60, yPos + 5);
            pdf.text("Documento", margin + 90, yPos + 5);
            pdf.text("Valor", margin + 150, yPos + 5);
            
            yPos += 10;
            
            const tablaAnticipos = document.getElementById('estado-anticipos-table');
            const filasAnticipos = tablaAnticipos.querySelectorAll('tbody tr');
            
            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(7);
            pdf.setTextColor(0, 0, 0);
            
            filaIndex = 0;
            filasAnticipos.forEach(fila => {
                if (yPos > pageHeight - margin - 10) {
                    pdf.addPage();
                    yPos = margin;
                    pdf.setFillColor(44, 62, 80);
                    pdf.rect(margin, yPos, contentWidth, 8, 'F');
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(8);
                    pdf.setTextColor(255, 255, 255);
                    pdf.text("Tercero", margin + 2, yPos + 5);
                    pdf.text("Fecha", margin + 60, yPos + 5);
                    pdf.text("Documento", margin + 90, yPos + 5);
                    pdf.text("Valor", margin + 150, yPos + 5);
                    yPos += 10;
                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(7);
                }
                
                if (filaIndex % 2 === 0) {
                    pdf.setFillColor(249, 249, 249);
                    pdf.rect(margin, yPos, contentWidth, 6, 'F');
                }
                
                const celdas = fila.querySelectorAll('td');
                pdf.setTextColor(0, 0, 0);
                pdf.text(celdas[0].textContent.substring(0, 30), margin + 2, yPos + 4);
                pdf.text(celdas[1].textContent, margin + 60, yPos + 4);
                pdf.text(celdas[2].textContent.substring(0, 20), margin + 90, yPos + 4);
                pdf.text(celdas[3].textContent, margin + 150, yPos + 4);
                
                yPos += 6;
                filaIndex++;
            });
            
            const fechaGeneracion = new Date().toLocaleDateString('es-CO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            pdf.setFont("helvetica", "italic");
            pdf.setFontSize(7);
            pdf.setTextColor(128, 128, 128);
            pdf.text(`Generado el ${fechaGeneracion} - ACUALIANZA & BAQUERO S.A.S.`, pageWidth / 2, pageHeight - 5, { align: "center" });
            
            if (pdf.setCompression) {
                pdf.setCompression(true);
            }
            
            pdf.save(nombreArchivo);
            
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        function exportarDOCX() {
            alert('Funcionalidad de exportación a DOCX en desarrollo.');
        }

        // --- FIN: Funciones de Exportación ---
    </script>
</body>

</html>

















